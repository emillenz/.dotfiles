#!/usr/bin/env ruby

# ---
# title:  switch audio output menu
# author: emil lenz
# email:  emillenz@protonmail.com
# date:   [2023-05-07]
# info: 
#   - intended for use with a WM
#   - ARGV passed as args to dmenu (use it to customize dmenu appearance)
# dependencies: dmenu, pactl
# ---

require "json"
require "open3"

def main
	sinks = JSON.parse(`pactl --format json list sinks`)
	sink_inputs = sinks.map { |sink| sink["description"] }.join("\n")

	selected_sink, status = Open3.capture2(
		"dmenu", "-p", "audio-output >", *ARGV,
		stdin_data: sink_inputs
	)
	exit(1) unless status.success?

	sink_id = sinks.find { |sink| sink["description"] == selected_sink.chomp }["index"]

	system("pactl set-default-sink #{sink_id}", exception: true)

	JSON.parse(`pactl --format json list sink-inputs`).map do |sink|
		system("pactl move-sink-input #{sink["index"]} #{sink_id}", exception: true)
	end

	system("dunstify 'audio input changed' '#{selected_sink}'", exception: true)
end

main
